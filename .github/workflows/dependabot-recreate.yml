name: Recreate Dependabot PRs on Branch Update

on:
  push:
    branches:
      - main
      - master

permissions:
  pull-requests: write
  contents: read

jobs:
  recreate-dependabot-prs:
    name: Recreate Dependabot Pull Requests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Get all open Dependabot pull requests
        id: get-prs
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: context.ref.replace('refs/heads/', ''),
              sort: 'updated',
              direction: 'desc'
            });

            // Filter for Dependabot PRs
            const dependabotPRs = pullRequests.filter(pr => 
              pr.user.type === 'Bot' && 
              (pr.user.login === 'dependabot[bot]' || pr.user.login === 'dependabot-preview[bot]')
            );

            console.log(`Found ${dependabotPRs.length} open Dependabot PR(s)`);

            // Store PR numbers as JSON for next step
            const prNumbers = dependabotPRs.map(pr => pr.number);
            return prNumbers;

      - name: Recreate Dependabot PRs
        if: steps.get-prs.outputs.result != '[]'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumbers = ${{ steps.get-prs.outputs.result }};

            if (!prNumbers || prNumbers.length === 0) {
              console.log('No Dependabot PRs to recreate');
              return;
            }

            console.log(`Recreating ${prNumbers.length} Dependabot PR(s)...`);

            for (const prNumber of prNumbers) {
              try {
                // Check if we already commented on this PR recently
                const { data: comments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                });

                const recentRecreateComment = comments.find(comment => 
                  comment.user.type === 'Bot' &&
                  comment.user.login === 'github-actions[bot]' &&
                  comment.body.includes('@dependabot recreate') &&
                  // Check if comment is from the last 5 minutes (to avoid spam)
                  new Date(comment.created_at) > new Date(Date.now() - 5 * 60 * 1000)
                );

                if (recentRecreateComment) {
                  console.log(`Skipping PR #${prNumber} - already recreated recently`);
                  continue;
                }

                // Comment to recreate the PR
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: '@dependabot recreate'
                });

                console.log(`✅ Recreated Dependabot PR #${prNumber}`);
                
                // Small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 1000));
              } catch (error) {
                console.error(`❌ Failed to recreate PR #${prNumber}:`, error.message);
              }
            }

            console.log(`Completed recreating ${prNumbers.length} Dependabot PR(s)`);
