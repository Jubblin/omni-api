name: Rebase Dependabot PRs on Branch Update

on:
  push:
    branches:
      - main
      - master

permissions:
  pull-requests: write
  contents: read

jobs:
  rebase-dependabot-prs:
    name: Rebase Dependabot Pull Requests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Rebase Dependabot PRs
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const baseBranch = context.ref.replace('refs/heads/', '');

            // Get all open pull requests targeting the base branch
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: baseBranch,
              sort: 'updated',
              direction: 'desc'
            });

            // Filter for Dependabot PRs
            const dependabotPRs = pullRequests.filter(pr => 
              pr.user.type === 'Bot' && 
              (pr.user.login === 'dependabot[bot]' || pr.user.login === 'dependabot-preview[bot]')
            );

            console.log(`Found ${dependabotPRs.length} open Dependabot PR(s) targeting ${baseBranch}`);

            if (dependabotPRs.length === 0) {
              console.log('No Dependabot PRs to rebase');
              return;
            }

            console.log(`Rebasing ${dependabotPRs.length} Dependabot PR(s)...`);

            for (const pr of dependabotPRs) {
              try {
                // Check if we already commented on this PR recently
                const { data: comments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                });

                const recentRebaseComment = comments.find(comment => 
                  comment.user.type === 'Bot' &&
                  comment.user.login === 'github-actions[bot]' &&
                  (comment.body.includes('@dependabot rebase') || comment.body.includes('@dependabot recreate')) &&
                  // Check if comment is from the last 5 minutes (to avoid spam)
                  new Date(comment.created_at) > new Date(Date.now() - 5 * 60 * 1000)
                );

                if (recentRebaseComment) {
                  console.log(`Skipping PR #${pr.number} - already rebased/recreated recently`);
                  continue;
                }

                // Try rebase first (less disruptive than recreate)
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: '@dependabot rebase'
                });

                console.log(`✅ Requested rebase for Dependabot PR #${pr.number} (${pr.title})`);
                
                // Small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 1000));
              } catch (error) {
                console.error(`❌ Failed to rebase PR #${pr.number}:`, error.message);
              }
            }

            console.log(`Completed rebasing ${dependabotPRs.length} Dependabot PR(s)`);
